#!/bin/sh -l
set -e

setup-ssh

if [ "$COMMAND" = "review-apps:create" ] || [ "$COMMAND" = 'review-apps:destroy' ]; then
  if [ -z "$REVIEW_APP_NAME" ]; then
    log-error "No review app name specified"
    exit 1
  fi
fi

app_name="$(parse-app-name)"
review_app_name="${REVIEW_APP_NAME}"
ssh_remote="ssh://dokku@$(parse-ssh-host):$(parse-ssh-port)"

if [ "$COMMAND" = "review-app:destroy" ]; then
  log-info "Destroying review app '${review_app_name}'"
  ssh "$ssh_remote" -- --force apps:destroy "$review_app_name"
  exit 0
fi

if [ -n "$COMMAND" ] && [ "$COMMAND" != "review-apps:create" ] && [ "$COMMAND" != "deploy" ]; then
  log-error "Invalid command specified"
  exit 1
fi

if [ "$COMMAND" = "review-apps:create" ]; then
  log-info "Ensuring review app '${review_app_name}' exists"
  ssh "$ssh_remote" -- apps:clone --skip-deploy --ignore-existing "$app_name" "$review_app_name"
fi

log-info "Pushing to Dokku Host"

if [ -n "$review_app_name" ] && [ "$app_name" != "$review_app_name" ]; then
  GIT_REMOTE_URL="${GIT_REMOTE_URL%"/$app_name"}/${review_app_name}"
fi

git push "$GIT_PUSH_FLAGS" "$GIT_REMOTE_URL" "$GITHUB_SHA:refs/heads/$BRANCH" --force
